{
    "id": "ad505872-03e2-439a-a6cb-14743cc4f5b2",
    "scriptName": "[DLC]Galgame",
    "findRegex": "<galtext>([\\s\\S]*?)<\\/galtext>",
    "replaceString": "```html\n<body>\n  <style>\n    /* --- Reset & Base --- */\n    html, body {\n        margin: 0;\n        padding: 0;\n        font-family: sans-serif;\n    }\n\n    /* --- Animations --- */\n    @keyframes shake-animation {\n      0% { transform: translate(0, 0) rotate(0); }\n      10%, 30%, 50%, 70%, 90% { transform: translate(-3px, 3px) rotate(-1deg); }\n      20%, 40%, 60%, 80%, 100% { transform: translate(3px, -3px) rotate(1deg); }\n    }\n    .shake {\n      animation: shake-animation 0.3s;\n    }\n\n    @keyframes fadeInOnly {\n      from { opacity: 0; }\n      to { opacity: 1; }\n    }\n    .fade-in-effect {\n        animation: fadeInOnly 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;\n    }\n\n    /* --- Non-linear Toast Animations --- */\n    @keyframes toastSlideIn {\n        0% {\n            opacity: 0;\n            transform: translateY(20px) scale(0.9);\n        }\n        100% {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n        }\n    }\n    @keyframes toastSlideOut {\n        0% {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n        }\n        100% {\n            opacity: 0;\n            transform: translateY(20px) scale(0.9);\n        }\n    }\n\n    /* --- Body & Background Effects --- */\n    body {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      min-height: 60vh;\n      background-size: cover;\n      background-position: center;\n      cursor: pointer;\n      position: relative;\n      overflow: hidden;\n    }\n\n    #backgroundBlurLayer {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        background-size: cover;\n        background-position: center;\n        filter: blur(5px);\n        opacity: 0;\n        transition: opacity 0.5s ease-in-out, filter 0.5s ease-in-out;\n        z-index: -1;\n        pointer-events: none;\n    }\n    #backgroundBlurLayer.show-blur {\n        opacity: 1;\n    }\n    #backgroundBlurLayer.event-blur {\n        filter: blur(10px);\n    }\n\n    #mainUI {\n        transition: opacity 0.5s ease-in-out;\n        width: 100%;\n        max-width: 1200px;\n        padding: 0 20px;\n        box-sizing: border-box;\n    }\n\n    /* --- Control Button Styles --- */\n    .controls-container {\n        position: fixed;\n        top: 20px;\n        display: flex;\n        gap: 10px;\n        z-index: 1001;\n    }\n    #topRightControls {\n        right: 20px;\n    }\n    .control-button {\n        width: 31.5px;\n        height: 31.5px;\n        background-color: rgba(0, 0, 0, 0.25);\n        backdrop-filter: blur(8px);\n        -webkit-backdrop-filter: blur(8px);\n        border-radius: 8px;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        cursor: pointer;\n        transition: background-color 0.2s ease, transform 0.1s ease;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n    }\n    .control-button .iconify {\n        font-size: 18px;\n        color: white;\n    }\n    .control-button:hover {\n        background-color: rgba(0, 0, 0, 0.4);\n    }\n    .control-button:active {\n        background-color: rgba(0, 0, 0, 0.6);\n        transform: scale(0.95);\n    }\n\n    /* --- Start Screen --- */\n    #startScreen {\n        display: none;\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        justify-content: center;\n        align-items: center;\n        z-index: 5000;\n    }\n    #startText {\n        color: white;\n        font-size: 1.2em;\n        text-shadow: 2px 2px 8px rgba(0,0,0,0.7);\n        text-align: center;\n        padding: 20px;\n        z-index: 5001;\n    }\n\n    /* --- Main UI --- */\n    #nameTag {\n        align-self: flex-start;\n        background-color: rgba(0, 0, 0, 0.2);\n        border-radius: 10px;\n        padding: 5px 10px;\n        margin-bottom: 5px;\n    }\n    #nameText {\n        color: white;\n        font-size: 16px; /* 稍微增大 */\n        font-family: 'SimSun', '宋體', serif;\n    }\n    #dialogContainer {\n        background-color: rgba(0, 0, 0, 0.2);\n        border-radius: 15px;\n        padding: 15px;\n        flex: 1;\n        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        align-items: center;\n        width: 100%;\n        position: relative;\n    }\n    #dialogText {\n        margin: 0;\n        color: white;\n        /* font-size will be set by JS */\n        text-align: center;\n        word-wrap: break-word;\n        word-break: break-word;\n        max-width: 100%;\n        font-family: 'SimSun', '宋體', serif;\n    }\n    #bounceBall {\n        position: absolute;\n        bottom: 10px;\n        right: 10px;\n        width: 8px;\n        height: 8px;\n        background-color: rgba(255, 255, 255, 0.3);\n        border-radius: 50%;\n    }\n\n    /* --- Options --- */\n    #optionsContainer {\n        display: none;\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        text-align: center;\n        z-index: 2000;\n    }\n    .option-button {\n        color: white;\n        font-size: 16px; /* 稍微增大 */\n        font-family: 'SimSun', '宋體', serif;\n        padding: 10px 20px; /* 稍微增大 */\n        margin: 10px; /* 稍微增大 */\n        cursor: pointer;\n        border-radius: 8px;\n        background-color: rgba(0,0,0,0.5);\n        min-width: 140px; /* 稍微增大 */\n    }\n    .option-button:hover {\n        background-color: rgba(255,255,255,0.3);\n    }\n    .option-button:active {\n        background-color: rgba(0,0,0,0.7);\n    }\n\n    /* --- Overlays --- */\n    #transitionOverlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        background-color: black;\n        opacity: 0;\n        z-index: 9999;\n        pointer-events: none;\n        transition: opacity 0.5s ease-in-out;\n    }\n\n    /* --- Event Modal --- */\n    #eventModal {\n        display: flex;\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100vw;\n        height: 100vh;\n        background-color: rgba(0, 0, 0, 0.7);\n        justify-content: center;\n        align-items: center;\n        z-index: 3000;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease-in-out;\n    }\n    #eventModal.visible {\n        opacity: 1;\n        pointer-events: auto;\n    }\n    #eventModalContent {\n        background-color: rgba(30, 30, 30, 0.8);\n        border-radius: 15px;\n        padding: 20px;\n        width: 80%;\n        max-width: 500px;\n        text-align: center;\n        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);\n        position: relative;\n        overflow: hidden;\n    }\n    #eventModalContent::before {\n        content: \"事件\";\n        position: absolute;\n        top: 10px;\n        left: 15px;\n        color: #aaa;\n        font-size: 20px; /* 增大 */\n        font-weight: bold;\n    }\n    #eventImage {\n        width: 100%;\n        aspect-ratio: 16 / 9;\n        object-fit: contain;\n        border-radius: 10px;\n        margin-top: 20px;\n        margin-bottom: 15px;\n        background-color: rgba(255, 255, 255, 0.1);\n    }\n    #eventContent {\n        color: white;\n        font-size: 16px; /* 增大 */\n        font-family: 'SimSun', '宋體', serif;\n        margin: 0;\n        word-wrap: break-word;\n        word-break: break-word;\n    }\n\n    /* --- Error Toast --- */\n    #errorToast {\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        width: 25%;\n        padding: 15px;\n        background-color: rgba(255, 0, 0, 0.25); /* 25% 紅色透明度 */\n        color: white;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n        font-size: 14px;\n        z-index: 10000;\n        opacity: 0;\n        transform: translateY(20px);\n        pointer-events: none;\n    }\n    #errorToast.show {\n        animation: toastSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;\n    }\n    #errorToast.hide {\n        animation: toastSlideOut 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;\n    }\n\n    /* --- Audio Players (Hidden) --- */\n    #bgmPlayer, #sfxPlayer {\n        display: none;\n    }\n\n    /* --- Responsive Design --- */\n    @media (max-width: 768px) {\n        .control-button {\n            width: 28px;\n            height: 28px;\n        }\n        .control-button .iconify {\n            font-size: 16px;\n        }\n        #nameText {\n            font-size: 14px; /* 調整行動端大小 */\n        }\n        #dialogContainer {\n            padding: 12px;\n            border-radius: 12px;\n        }\n        .option-button {\n            font-size: 14px; /* 調整行動端大小 */\n            padding: 8px 16px; /* 調整行動端大小 */\n            margin: 8px; /* 調整行動端大小 */\n            min-width: 120px; /* 調整行動端大小 */\n        }\n        #eventModalContent {\n            padding: 15px;\n            border-radius: 12px;\n        }\n        #eventModalContent::before {\n            font-size: 18px; /* 調整行動端大小 */\n            top: 8px;\n            left: 12px;\n        }\n        #eventContent {\n            font-size: 14px; /* 調整行動端大小 */\n        }\n        #errorToast {\n            font-size: 12px;\n            padding: 12px;\n            bottom: 15px;\n            right: 15px;\n        }\n    }\n\n    @media (max-width: 480px) {\n        .control-button {\n            width: 24px;\n            height: 24px;\n        }\n        .control-button .iconify {\n            font-size: 14px;\n        }\n        #nameText {\n            font-size: 12px; /* 調整小屏行動端大小 */\n        }\n        #dialogContainer {\n            padding: 10px;\n            border-radius: 10px;\n        }\n        .option-button {\n            font-size: 12px; /* 調整小屏行動端大小 */\n            padding: 6px 12px; /* 調整小屏行動端大小 */\n            margin: 6px; /* 調整小屏行動端大小 */\n            min-width: 100px; /* 調整小屏行動端大小 */\n        }\n        #eventModalContent {\n            padding: 12px;\n            border-radius: 10px;\n        }\n        #eventModalContent::before {\n            font-size: 16px; /* 調整小屏行動端大小 */\n            top: 6px;\n            left: 10px;\n        }\n        #eventContent {\n            font-size: 12px; /* 調整小屏行動端大小 */\n        }\n        #errorToast {\n            font-size: 10px;\n            padding: 10px;\n            bottom: 10px;\n            right: 10px;\n            width: 30%;\n        }\n    }\n  </style>\n\n  <script src=\"https://code.iconify.design/3/3.1.1/iconify.min.js\"></script>\n\n  <audio id=\"bgmPlayer\" loop></audio>\n  <audio id=\"sfxPlayer\"></audio>\n\n  <div id=\"transitionOverlay\"></div>\n  <div id=\"backgroundBlurLayer\"></div>\n\n  <div id=\"startScreen\">\n      <p id=\"startText\"></p>\n  </div>\n\n  <div id=\"mainUI\">\n    <div style=\"position: fixed; top: 20px; left: 20px; z-index: 1000;\">\n      <div style=\"color: rgba(135, 206, 250, 0.7); font-size: 14px; font-weight: normal; line-height: 1; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);\">Next</div>\n      <div style=\"color: rgba(255, 255, 255, 0.7); font-size: 18px; font-weight: bold; line-height: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);\">Sudachi</div>\n    </div>\n\n    <div id=\"topRightControls\" class=\"controls-container\">\n        <div id=\"muteButton\" class=\"control-button\" title=\"靜音\">\n            <span class=\"iconify\" data-icon=\"mdi:volume-high\"></span>\n        </div>\n        <div id=\"restartButton\" class=\"control-button\" title=\"重新開始\">\n            <span class=\"iconify\" data-icon=\"mdi:restart\"></span>\n        </div>\n        <div id=\"endButton\" class=\"control-button\" title=\"跳轉到結尾\">\n            <span class=\"iconify\" data-icon=\"mdi:skip-next\"></span>\n        </div>\n        <div id=\"playButton\" class=\"control-button\" title=\"自動播放\">\n            <span class=\"iconify\" data-icon=\"mdi:play\"></span>\n        </div>\n    </div>\n\n    <div style=\"position: fixed; bottom: 0; left: 0; right: 0; height: 30vh; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;\">\n      <div id=\"nameTag\">\n        <span id=\"nameText\">系統消息</span>\n      </div>\n      <div id=\"dialogContainer\">\n        <p id=\"dialogText\"></p>\n        <div id=\"bounceBall\"></div>\n      </div>\n    </div>\n  </div>\n\n  <div id=\"optionsContainer\">\n    <div id=\"option1\" class=\"option-button\"></div>\n    <div id=\"option2\" class=\"option-button\"></div>\n    <div id=\"option3\" class=\"option-button\"></div>\n  </div>\n\n  <div id=\"eventModal\">\n    <div id=\"eventModalContent\">\n      <img id=\"eventImage\" src=\"\" alt=\"事件圖片\">\n      <p id=\"eventContent\"></p>\n    </div>\n  </div>\n\n  <!-- 報錯提示框 -->\n  <div id=\"errorToast\"></div>\n\n  <script type=\"text/data\" id=\"messageData\">\n<data>\n{{match}}\n</data>\n  </script>\n\n  <script type=\"text/music_res\" id=\"musicResData\">\n<music_res>\n日常|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/daily.mp3\n戀愛|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/love.mp3\n大事之後|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/after_big_things.mp3\n科幻感|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/techno.mp3\n寧靜|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/queit.mp3\n</music_res>\n  </script>\n\n  <script type=\"text/sfx_res\" id=\"sfxResData\">\n<sfx_res>\n行走|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/walking.mp3\n奔跑|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/running.mp3\n雨聲|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/rainning.mp3\n眾人大笑|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/laugh_minasang.mp3\n烹飪|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/cooking.mp3\n鳥聲|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/birdssound.mp3\n鈴聲|https://github.com/LimeBlogs/Sudachi-Res/raw/refs/heads/master/music/sfx/bell-ring.mp3\n</sfx_res>\n  </script>\n\n  <script type=\"text/img_res\" id=\"imgResData\">\n<img_res>\n教室|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/classroom.png\n森林|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/forest.png\n洞穴|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/cave.png\n大洞穴|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/big_cave.png\n校門口|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/school_gate.png\n客廳|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/livingroom.png\n市場|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/market.png\n大山|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/mountain.png\n手機|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/phone.png\n商店|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/shop.png\n街道|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/street.png\n臥室|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/bedroom.png\n夜晚臥室|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/bedroom_night.png\n星空|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/IMG_20250907_211430.png\n藍天|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/white_clouds.png\n高樓|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/tall_buiding.png\n空地|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/empty_land.png\n草地|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/glasses.png\n廁所|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/wc.png\n浴室|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/washroom.png\n操場|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/playground.png\n田野|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/field.png\n食堂|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/dining_hall.png\n超市|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/supermarket.png\n害羞女|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/kid_seikaku_uchiki_girl.png\n害羞男|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/kid_seikaku_uchiki_boy.png\n嚴肅男|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/job_news_caster_man_serious.png\n嚴肅女|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/job_news_caster_woman_serious.png\n憤怒男|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/face_angry_man3.png\n憤怒女|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/face_angry_woman3.png\n泡茶|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/tea_chakoboshi_suteru.png\n茶|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/tea2.png\n雞蛋|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/tamago_pack.png\n塑料袋|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/shopping_bag_rejibukuro.png\n曲奇|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/sweets_cookie.png\n洋芋片|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/potatochips_fukuro_orange.png\n碗和盤|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/osara_white.png\n攪拌器|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/cooking_dendou_mixer.png\n悲傷|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/tobotobo_aruku_woman.png\n一袋大米|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/food_kome_pack_rice.png\n歡呼|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/happy_woman6.png\n喜極而泣|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/internet_kanki_man1.png\n騎自行車很累|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/bike_tired.png\n勝利|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/yusyou_flag.png\n放學|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/tsugaku.png\n自動販賣機|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/syouhin_tana_reitou_open.png\n傘下男女|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/summer_higasa_couple_school.png\n睡覺女|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/sleep_top_woman.png\n睡覺男|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/sleep_top_man.png\n女被窩玩手機|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/sleep_futon_smartphone_woman.png\n男被窩玩手機|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/sleep_top_man.png\n看報紙|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/shinbun_ojiisan.png\n報紙|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/school_gakkyu_shinbun.png\n地震|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/roukyuka_boroboro_building2.png\n便當|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/pulp_mold_obentou.png\n商店|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/omise_shop_tatemono.png\n體溫計|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/medical_taionkei_hand_375.png\n湯|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/food_paitan_soup.png\n生日花束|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/bouquet_birthday.png\n可樂|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/drink_cola_zero_petbottle.png\n收起旳傘|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/kasa_umbrella_oritatami.png\n鍋鏟|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/cooking_hera.png\n倉鼠|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/animal_mawashi_guruma_chinchira.png\n向日葵|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/flower_himawari_leaf_mark.png\n雜物堆|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/gomi_shigen.png\n嘴巴塞棉籤|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/medical_influenza_kensa_mouth.png\n番劇用品店|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/building_anime_shop.png\n井底之蛙|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/kotowaza_inonaka_kawazu.png\n春遊|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/bug_chou_tawamureru_kids.png\n橘子|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/fruit_orange2.png\n火爐|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/food_sichirin.png\n書本|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/book3_blue.png\n計程車|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/car_taxi_wagon.png\n書包|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/school_randoseru_black_open_full.png\n種地|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/hatake_tagayasu_woman.png\n鳥兒|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/bird_inko_yaseika_denchu.png\n石橋|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/landmark_tausyubetsu_bridge.png\n暗戀|https://raw.githubusercontent.com/LimeBlogs/Sudachi-Res/refs/heads/master/irasutoya/school_kataomoi_kyoushitsu_boy.png\n</img_res>\n  </script>\n\n  <script>\n    // --- Utility Functions ---\n    const parseResources = (elementId, tag) => {\n      const resources = {};\n      const rawData = document.getElementById(elementId)?.textContent;\n      if (!rawData) return resources;\n      const match = rawData.match(new RegExp(`<${tag}>([\\\\s\\\\S]*)<\\\\/${tag}>`));\n      if (!match) return resources;\n      match[1].trim().split('\\n').filter(line => line.trim()).forEach(line => {\n        const [name, ...urlParts] = line.split('|');\n        const url = urlParts.join('|');\n        if (name && url) resources[name.trim()] = url.trim();\n      });\n      return resources;\n    };\n\n    const parseMessagesAndOptions = (elementId, tag) => {\n        const messages = [];\n        const rawData = document.getElementById(elementId)?.textContent;\n        if (!rawData) return messages;\n        const match = rawData.match(new RegExp(`<${tag}>([\\\\s\\\\S]*)<\\\\/${tag}>`));\n        if (!match) return messages;\n\n        const lines = match[1].trim().split('\\n').filter(line => line.trim());\n        let currentMessage = null;\n\n        lines.forEach(line => {\n            if (line.startsWith('Event|')) {\n                const parts = line.split('|');\n                if (parts.length >= 3) {\n                    messages.push({\n                        type: 'event',\n                        name: 'Event',\n                        content: parts[1].trim() || \"無內容\",\n                        background: parts[2].trim() || \"無\"\n                    });\n                }\n            }\n            else if (line.includes('|') && !line.startsWith('[')) {\n                const parts = line.split('|');\n                const [name, content, background, music, sfx, transition] = parts.map(p => (p || \"\").trim() || \"無\");\n                currentMessage = {\n                    type: 'dialog',\n                    name,\n                    content,\n                    background,\n                    music,\n                    sfx,\n                    transition,\n                    options: []\n                };\n                messages.push(currentMessage);\n            }\n            else if (line.startsWith('[') && currentMessage && currentMessage.type === 'dialog') {\n                const optionText = line.replace(/\\[|\\]/g, '').trim();\n                if (optionText) {\n                    currentMessage.options.push(optionText);\n                }\n            }\n        });\n        return messages;\n    };\n\n    // --- State & DOM Elements ---\n    const DOM = {\n        body: document.body,\n        backgroundBlurLayer: document.getElementById('backgroundBlurLayer'),\n        mainUI: document.getElementById('mainUI'),\n        startScreen: document.getElementById('startScreen'),\n        startText: document.getElementById('startText'),\n        dialogText: document.getElementById('dialogText'),\n        nameText: document.getElementById('nameText'),\n        dialogContainer: document.getElementById('dialogContainer'),\n        bounceBall: document.getElementById('bounceBall'),\n        optionsContainer: document.getElementById('optionsContainer'),\n        option1: document.getElementById('option1'),\n        option2: document.getElementById('option2'),\n        option3: document.getElementById('option3'),\n        bgmPlayer: document.getElementById('bgmPlayer'),\n        sfxPlayer: document.getElementById('sfxPlayer'),\n        transitionOverlay: document.getElementById('transitionOverlay'),\n        playButton: document.getElementById('playButton'),\n        muteButton: document.getElementById('muteButton'),\n        restartButton: document.getElementById('restartButton'),\n        endButton: document.getElementById('endButton'),\n        eventModal: document.getElementById('eventModal'),\n        eventImage: document.getElementById('eventImage'),\n        eventContent: document.getElementById('eventContent'),\n        errorToast: document.getElementById('errorToast')\n    };\n\n    let state = {\n        currentMessageIndex: 0,\n        currentSegmentIndex: 0,\n        currentIndex: 0,\n        isTyping: false,\n        allMessagesDisplayed: false,\n        autoPlay: false,\n        userInteracted: false,\n        currentBgm: null,\n        currentBackgroundUrl: null,\n        processedMessages: [],\n        messageInfo: [],\n        typingTimeoutId: null,\n        isMuted: false,\n        musicResources: {},\n        imgResources: {},\n        sfxResources: {},\n        messagesAndOptions: [],\n        wasAutoPlayBeforeEvent: false\n    };\n\n    // --- Initialization ---\n    function init() {\n        loadResources();\n        setupEventListeners();\n        adjustFontSize();\n        processMessages();\n        updateDialogContent();\n        executeTransition(() => {\n            renderCurrentMessage();\n        });\n        animateBounceBall();\n    }\n\n    function loadResources() {\n        state.musicResources = parseResources('musicResData', 'music_res');\n        state.imgResources = parseResources('imgResData', 'img_res');\n        state.sfxResources = parseResources('sfxResData', 'sfx_res');\n        state.messagesAndOptions = parseMessagesAndOptions('messageData', 'data');\n\n        if (Object.keys(state.imgResources).length === 0) {\n            showErrorToast(\"警告: 背景圖片資源未載入或格式錯誤。\");\n        }\n        if (Object.keys(state.musicResources).length === 0) {\n            showErrorToast(\"警告: 背景音樂資源未載入或格式錯誤。\");\n        }\n        if (Object.keys(state.sfxResources).length === 0) {\n            showErrorToast(\"警告: 音效資源未載入或格式錯誤。\");\n        }\n        if (state.messagesAndOptions.length === 0) {\n            showErrorToast(\"警告: 對話消息未載入或格式錯誤。\");\n        }\n    }\n\n    function setupEventListeners() {\n        DOM.body.addEventListener('click', onBodyClick);\n        DOM.playButton.addEventListener('click', onPlayButtonClick);\n        DOM.muteButton.addEventListener('click', onMuteButtonClick);\n        DOM.restartButton.addEventListener('click', onRestartButtonClick);\n        DOM.endButton.addEventListener('click', onEndButtonClick);\n        DOM.option1.addEventListener('click', (e) => { e.stopPropagation(); handleOptionClick(DOM.option1.textContent); });\n        DOM.option2.addEventListener('click', (e) => { e.stopPropagation(); handleOptionClick(DOM.option2.textContent); });\n        DOM.option3.addEventListener('click', (e) => { e.stopPropagation(); handleOptionClick(DOM.option3.textContent); });\n        window.addEventListener('resize', onWindowResize);\n\n        DOM.eventModal.addEventListener('click', hideEventModal);\n        document.addEventListener('keydown', (e) => {\n            if (e.key === 'Escape' && DOM.eventModal.classList.contains('visible')) {\n                hideEventModal();\n            }\n        });\n    }\n\n    function adjustFontSize() {\n        const size = Math.max(14, Math.min(22, Math.floor(DOM.dialogContainer.offsetWidth / 20)));\n        DOM.dialogText.style.fontSize = `${size}px`;\n    }\n\n    // --- Message Processing ---\n    function processMessages() {\n        state.processedMessages = [];\n        state.messageInfo = [];\n        state.messagesAndOptions.forEach(item => {\n            state.messageInfo.push(item);\n            if (item.type === 'dialog') {\n                // 優化：增加每段最大字符數，避免訊息丟失\n                const maxChars = 45;\n                const content = item.content;\n                if (content.length <= maxChars) {\n                    state.processedMessages.push([content]);\n                } else {\n                    let segments = [];\n                    for (let i = 0; i < content.length; i += maxChars) {\n                        segments.push(content.substring(i, i + maxChars));\n                    }\n                    state.processedMessages.push(segments);\n                }\n            } else {\n                state.processedMessages.push([item.content]);\n            }\n        });\n    }\n\n    // --- UI Updates ---\n    function updateDialogContent() {\n        const info = getCurrentInfo();\n        if (info.type === 'dialog') {\n            DOM.nameText.textContent = info.name || \"系統消息\";\n        }\n    }\n\n    function showBlurLayer() {\n        DOM.backgroundBlurLayer.classList.add('show-blur');\n        DOM.backgroundBlurLayer.classList.remove('event-blur');\n    }\n    function hideBlurLayer() {\n        DOM.backgroundBlurLayer.classList.remove('show-blur');\n    }\n    function showEventBlur() {\n        DOM.backgroundBlurLayer.classList.add('show-blur', 'event-blur');\n    }\n    function hideEventBlur() {\n        DOM.backgroundBlurLayer.classList.remove('event-blur');\n    }\n\n    function showMainDialog() {\n        DOM.mainUI.style.display = 'block';\n        DOM.startScreen.style.display = 'none';\n        hideBlurLayer();\n        startTypingProcess();\n    }\n\n    function showStartScreen() {\n        const info = getCurrentInfo();\n        DOM.mainUI.style.display = 'none';\n        DOM.optionsContainer.style.display = 'none';\n        DOM.startScreen.style.display = 'flex';\n        showBlurLayer();\n        DOM.startText.textContent = info.content;\n        DOM.startText.classList.remove('fade-in-effect');\n        void DOM.startText.offsetWidth;\n        DOM.startText.classList.add('fade-in-effect');\n        updateMusic();\n        playSfx();\n    }\n\n    function renderCurrentMessage() {\n        const info = getCurrentInfo();\n        if (info.name === 'start') {\n            showStartScreen();\n        } else {\n            showMainDialog();\n        }\n    }\n\n    function showOptions() {\n        if (!state.allMessagesDisplayed) return;\n        DOM.bounceBall.style.display = 'none';\n\n        const currentMessageData = state.messageInfo[state.currentMessageIndex];\n        const options = currentMessageData && currentMessageData.type === 'dialog' ? currentMessageData.options : [];\n\n        DOM.option1.textContent = '';\n        DOM.option2.textContent = '';\n        DOM.option3.textContent = '';\n\n        if (options.length > 0) DOM.option1.textContent = options[0];\n        if (options.length > 1) DOM.option2.textContent = options[1];\n        if (options.length > 2) DOM.option3.textContent = options[2];\n\n        DOM.optionsContainer.style.display = 'block';\n        DOM.dialogContainer.style.pointerEvents = 'none';\n        DOM.body.style.cursor = 'default';\n    }\n\n    function closeDialog() {\n        DOM.optionsContainer.style.display = 'none';\n        DOM.dialogContainer.style.display = 'flex';\n        DOM.body.style.cursor = 'pointer';\n        DOM.dialogContainer.style.pointerEvents = 'auto';\n        state.allMessagesDisplayed = false;\n    }\n\n    // --- Audio ---\n    function updateMusic() {\n        if (state.isMuted) {\n            DOM.bgmPlayer.pause();\n            return;\n        }\n        const info = getCurrentInfo();\n        if (info.type === 'dialog' && info.music !== '無') {\n            const musicUrl = state.musicResources[info.music];\n            if (musicUrl) {\n                if (state.currentBgm !== info.music) {\n                    DOM.bgmPlayer.src = musicUrl;\n                    state.currentBgm = info.music;\n                    if (state.userInteracted) {\n                        DOM.bgmPlayer.play().catch(e => console.warn(\"BGM播放失敗:\", e));\n                    }\n                }\n            } else {\n                showErrorToast(`警告: 未找到音樂資源 \"${info.music}\"。`);\n            }\n        } else {\n            if (DOM.bgmPlayer.src) {\n                DOM.bgmPlayer.pause();\n            }\n        }\n    }\n\n    // Bug修復：更新 playSfx 函數，確保在靜音狀態下永不播放\n    function playSfx() {\n        // 修復：如果當前是靜音狀態，則不播放任何音效\n        if (state.isMuted) {\n            return;\n        }\n        // 不再檢查 state.isMuted，因為上面已經處理了\n        const info = getCurrentInfo();\n        if (info.type === 'dialog' && info.sfx !== '無') {\n            const sfxUrl = state.sfxResources[info.sfx];\n            if (sfxUrl) {\n                // 總是嘗試播放或重新播放音效\n                DOM.sfxPlayer.src = sfxUrl;\n                DOM.sfxPlayer.currentTime = 0; // 重置播放位置\n                DOM.sfxPlayer.play().catch(e => {\n                    console.warn(\"SFX播放失敗:\", e);\n                    // 可以選擇在這裡不顯示錯誤，因為可能是用戶未交互\n                });\n            } else {\n                showErrorToast(`警告: 未找到音效資源 \"${info.sfx}\"。`);\n            }\n        }\n        // 如果 sfx 是 '無'，則不執行任何操作，自然不會播放\n    }\n\n    // 新增：停止音效的函數\n    function stopSfx() {\n        if (DOM.sfxPlayer.src) {\n            DOM.sfxPlayer.pause();\n            DOM.sfxPlayer.currentTime = 0; // 重置播放位置\n        }\n    }\n\n    // --- Transitions & Animations ---\n    function executeTransition(callback) {\n        const info = getCurrentInfo();\n        let newUrl = null;\n        let transitionType = 'none';\n\n        if (info.type === 'dialog') {\n            newUrl = state.imgResources[info.background];\n            transitionType = info.transition;\n        }\n\n        const applyBackground = (onComplete) => {\n            if (newUrl && newUrl !== state.currentBackgroundUrl) {\n                const imageUrl = `url('${newUrl}')`;\n                DOM.body.style.backgroundImage = imageUrl;\n                DOM.backgroundBlurLayer.style.backgroundImage = imageUrl;\n                state.currentBackgroundUrl = newUrl;\n            }\n            if (onComplete) onComplete();\n        };\n\n        if (transitionType === 'fade' && info.type === 'dialog') {\n            DOM.transitionOverlay.style.pointerEvents = 'auto';\n            DOM.transitionOverlay.style.opacity = 1;\n            DOM.mainUI.style.opacity = 0;\n            setTimeout(() => {\n                updateDialogContent();\n                updateMusic();\n                playSfx(); // 播放新消息的音效\n                applyBackground();\n                if (callback) callback();\n                DOM.transitionOverlay.style.opacity = 0;\n                DOM.mainUI.style.opacity = 1;\n                setTimeout(() => {\n                    DOM.transitionOverlay.style.pointerEvents = 'none';\n                }, 500);\n            }, 500);\n        } else {\n            updateDialogContent();\n            updateMusic();\n            playSfx(); // 播放新消息的音效\n            applyBackground(() => {\n                if (info.type === 'dialog' && transitionType === 'shake') {\n                    DOM.body.classList.add('shake');\n                    setTimeout(() => {\n                        DOM.body.classList.remove('shake');\n                        if (callback) callback();\n                    }, 300);\n                } else {\n                    if (callback) callback();\n                }\n            });\n        }\n    }\n\n    // 新增：為特定消息索引執行過渡的函數，用於修復重啟按鈕的bug\n    function executeTransitionForMessage(messageIndex) {\n        const originalIndex = state.currentMessageIndex;\n        state.currentMessageIndex = messageIndex;\n        executeTransition(() => {\n            renderCurrentMessage();\n        });\n        state.currentMessageIndex = originalIndex;\n    }\n\n\n    function animateBounceBall() {\n        if (state.allMessagesDisplayed || state.isTyping) {\n            DOM.bounceBall.style.display = 'none';\n            return;\n        }\n        DOM.bounceBall.style.display = 'block';\n        let time = 0;\n        const amp = 12;\n        const freq = 0.2;\n        const bounce = () => {\n            if (state.allMessagesDisplayed || state.isTyping) {\n                DOM.bounceBall.style.display = 'none';\n                return;\n            }\n            DOM.bounceBall.style.transform = `translateY(${-Math.abs(Math.sin(time * freq)) * amp}px)`;\n            time += 0.3;\n            requestAnimationFrame(bounce);\n        };\n        requestAnimationFrame(bounce);\n    }\n\n    // --- Typing & Message Flow ---\n    function startTypingProcess() {\n        if (state.typingTimeoutId !== null) {\n            clearTimeout(state.typingTimeoutId);\n            state.typingTimeoutId = null;\n        }\n        state.currentIndex = 0;\n        state.isTyping = true;\n        typeText();\n    }\n\n    function typeText() {\n        if (!state.isTyping) return;\n        const currentSegments = state.processedMessages[state.currentMessageIndex];\n        if (!currentSegments) return;\n        const segment = currentSegments[state.currentSegmentIndex];\n        if (segment === undefined) return;\n        DOM.dialogText.textContent = segment.substring(0, state.currentIndex);\n        if (state.currentIndex < segment.length) {\n            state.currentIndex++;\n            state.typingTimeoutId = setTimeout(typeText, Math.random() * 30 + 20);\n        } else {\n            state.isTyping = false;\n            state.typingTimeoutId = null;\n\n            // 優化：檢查是否還有更多段落需要顯示\n            if (state.currentSegmentIndex < currentSegments.length - 1) {\n                // 還有更多段落，準備顯示下一段\n                if (state.autoPlay && !state.allMessagesDisplayed) {\n                    setTimeout(() => {\n                        state.currentSegmentIndex++;\n                        state.currentIndex = 0;\n                        state.isTyping = true;\n                        typeText();\n                    }, 1200);\n                }\n            } else {\n                // 當前消息的所有段落都顯示完畢\n                if (state.autoPlay && !state.allMessagesDisplayed) {\n                    setTimeout(nextMessage, 1200);\n                }\n            }\n        }\n    }\n\n    function finishSegment() {\n        if (state.isTyping) {\n            if (state.typingTimeoutId !== null) {\n                clearTimeout(state.typingTimeoutId);\n                state.typingTimeoutId = null;\n            }\n            const currentSegments = state.processedMessages[state.currentMessageIndex];\n            const segment = currentSegments[state.currentSegmentIndex];\n            DOM.dialogText.textContent = segment;\n            state.currentIndex = segment.length;\n            state.isTyping = false;\n\n            // 優化：檢查是否還有更多段落需要顯示\n            if (state.currentSegmentIndex < currentSegments.length - 1) {\n                // 還有更多段落，準備顯示下一段\n                if (state.autoPlay) {\n                    setTimeout(() => {\n                        state.currentSegmentIndex++;\n                        startTypingProcess();\n                    }, 500); // 短暫延遲後自動播放下一段\n                }\n            } else {\n                // 當前消息的所有段落都顯示完畢\n                if (state.autoPlay && !state.allMessagesDisplayed) {\n                    setTimeout(nextMessage, 1200);\n                }\n            }\n        }\n    }\n\n    // Bug修復：在 nextMessage 中調用 stopSfx\n    function nextMessage() {\n        // 在處理下一條消息之前，停止當前的音效\n        stopSfx();\n\n        if (state.isTyping || state.allMessagesDisplayed) return;\n\n        let nextIndex = state.currentMessageIndex + 1;\n\n        while (nextIndex < state.messageInfo.length) {\n            const nextInfo = state.messageInfo[nextIndex];\n\n            if (nextInfo.type === 'event') {\n                state.currentMessageIndex = nextIndex;\n                showEventModal(nextInfo.content, nextInfo.background);\n                return;\n            }\n\n            if (nextInfo.type === 'dialog') {\n                state.currentMessageIndex = nextIndex;\n                state.currentSegmentIndex = 0; // 重置段落索引\n                executeTransition(() => renderCurrentMessage());\n                return;\n            }\n            nextIndex++;\n        }\n\n        state.allMessagesDisplayed = true;\n        DOM.dialogText.textContent = \"\";\n        typeEndText();\n    }\n\n    function typeEndText() {\n        DOM.bgmPlayer.pause();\n        const endText = \"對話結束\";\n        let i = 0;\n        const typeChar = () => {\n            if (i < endText.length) {\n                DOM.dialogText.textContent += endText.charAt(i++);\n                setTimeout(typeChar, 50);\n            } else {\n                showOptions();\n            }\n        };\n        typeChar();\n    }\n\n    // --- Event Modal Functions ---\n    function showEventModal(content, imageResourceName) {\n        state.wasAutoPlayBeforeEvent = state.autoPlay;\n        if (state.autoPlay) {\n            onPlayButtonClick(new Event('click'));\n        }\n\n        DOM.eventContent.textContent = content;\n        const imageUrl = state.imgResources[imageResourceName];\n        if (imageUrl) {\n            DOM.eventImage.src = imageUrl;\n            DOM.eventImage.style.display = 'block';\n        } else {\n            DOM.eventImage.src = '';\n            DOM.eventImage.style.display = 'none';\n            showErrorToast(`警告: 未找到事件圖片資源 \"${imageResourceName}\"。`);\n        }\n\n        showEventBlur();\n        DOM.eventModal.classList.add('visible');\n        DOM.body.style.cursor = 'default';\n        DOM.dialogContainer.style.pointerEvents = 'none';\n    }\n\n    function hideEventModal() {\n        DOM.eventModal.classList.remove('visible');\n        hideEventBlur();\n        DOM.body.style.cursor = 'pointer';\n        DOM.dialogContainer.style.pointerEvents = 'auto';\n\n        setTimeout(() => {\n            if (state.wasAutoPlayBeforeEvent && !state.autoPlay) {\n                 onPlayButtonClick(new Event('click'));\n            }\n            nextMessage();\n        }, 300);\n    }\n\n    // --- Event Handlers ---\n    // ✅ BUG 修復：更新 onBodyClick 函數，修復長文本分段顯示邏輯\n    function onBodyClick() {\n        if (DOM.eventModal.classList.contains('visible')) {\n            return;\n        }\n        handleFirstInteraction();\n        if (state.isTyping) {\n            finishSegment();\n        } else {\n            // ✅ 修復：在進入下一條消息前，檢查當前消息是否還有更多段落\n            const currentSegments = state.processedMessages[state.currentMessageIndex];\n            if (currentSegments && state.currentSegmentIndex < currentSegments.length - 1) {\n                // 如果有，則顯示下一個段落\n                state.currentSegmentIndex++;\n                startTypingProcess();\n            } else {\n                // 如果沒有，才進入下一條消息\n                nextMessage();\n            }\n        }\n    }\n\n    function onPlayButtonClick(e) {\n        e.stopPropagation();\n        handleFirstInteraction();\n        state.autoPlay = !state.autoPlay;\n        const icon = DOM.playButton.querySelector('.iconify');\n        icon.dataset.icon = state.autoPlay ? 'mdi:pause' : 'mdi:play';\n\n        if (state.autoPlay && !state.allMessagesDisplayed && DOM.bgmPlayer.paused && DOM.bgmPlayer.src && !state.isMuted) {\n            DOM.bgmPlayer.play().catch(e => console.warn(\"BGM播放失敗:\", e));\n        }\n\n        if (state.autoPlay && !state.isTyping && !state.allMessagesDisplayed) {\n            onBodyClick(); // 使用 onBodyClick 來統一處理邏輯，確保分段也能正確播放\n        }\n    }\n\n    // Bug修復：更新 onMuteButtonClick 函數，修復取消靜音後音效無法恢復的問題\n    function onMuteButtonClick(e) {\n        e.stopPropagation();\n        state.isMuted = !state.isMuted;\n        const icon = DOM.muteButton.querySelector('.iconify');\n        icon.dataset.icon = state.isMuted ? 'mdi:volume-off' : 'mdi:volume-high';\n        if (state.isMuted) {\n            DOM.bgmPlayer.pause();\n            // 靜音時也停止音效\n            stopSfx();\n        } else {\n            if (state.userInteracted && DOM.bgmPlayer.src && DOM.bgmPlayer.paused) {\n                DOM.bgmPlayer.play().catch(e => {});\n            }\n            // 修復：取消靜音時，嘗試播放當前消息的音效\n            if (state.userInteracted) {\n                playSfx();\n            }\n        }\n    }\n\n    // Bug修復：更新 onRestartButtonClick 函數，修復重啟後無法載入首條消息音訊的問題\n    function onRestartButtonClick(e) {\n        e.stopPropagation();\n        // 重啟時停止所有音訊\n        stopSfx();\n        if (state.typingTimeoutId !== null) {\n            clearTimeout(state.typingTimeoutId);\n            state.typingTimeoutId = null;\n        }\n        state.currentMessageIndex = 0;\n        state.currentSegmentIndex = 0;\n        state.currentIndex = 0;\n        state.isTyping = false;\n        state.allMessagesDisplayed = false;\n        state.autoPlay = false;\n        state.wasAutoPlayBeforeEvent = false;\n        DOM.playButton.querySelector('.iconify').dataset.icon = 'mdi:play';\n        DOM.optionsContainer.style.display = 'none';\n        DOM.dialogContainer.style.display = 'flex';\n        DOM.bounceBall.style.display = 'block';\n        DOM.dialogContainer.style.pointerEvents = 'auto';\n        DOM.body.style.cursor = 'pointer';\n        hideBlurLayer();\n        hideEventBlur();\n        DOM.body.classList.remove('shake');\n        DOM.transitionOverlay.style.opacity = 0;\n        DOM.transitionOverlay.style.pointerEvents = 'none';\n        DOM.eventModal.classList.remove('visible');\n\n        // 修復：直接為第一條對話消息（索引1）執行過渡，而不是依賴 renderCurrentMessage 的邏輯\n        // renderCurrentMessage(); // 移除這行\n        executeTransitionForMessage(1); // 新增這行\n\n        animateBounceBall();\n    }\n\n\n    function onEndButtonClick(e) {\n        e.stopPropagation();\n        // 跳轉結束時停止音效\n        stopSfx();\n        if (state.typingTimeoutId !== null) {\n            clearTimeout(state.typingTimeoutId);\n            state.typingTimeoutId = null;\n        }\n        state.isTyping = false;\n        state.allMessagesDisplayed = false;\n\n        for (let i = state.messageInfo.length - 1; i >= 0; i--) {\n            if (state.messageInfo[i].type === 'dialog') {\n                state.currentMessageIndex = i;\n                break;\n            }\n        }\n        state.currentSegmentIndex = 0;\n        executeTransition(() => {\n            renderCurrentMessage();\n            state.allMessagesDisplayed = true;\n            DOM.dialogText.textContent = \"\";\n            showOptions();\n        });\n    }\n\n    function onWindowResize() {\n        adjustFontSize();\n    }\n\n    async function handleOptionClick(optionText) {\n        if (typeof window.triggerSlash === 'function') {\n            try {\n                await window.triggerSlash(`/send ${optionText}`);\n                console.log(`已發送選項: /send ${optionText}`);\n            } catch (error) {\n                console.error(\"發送選項時出錯:\", error);\n            }\n        } else {\n            console.warn(\"SillyTavern API 'triggerSlash' 未找到。無法發送選項:\", optionText);\n        }\n\n        if (typeof window.triggerSlash === 'function') {\n            try {\n                await window.triggerSlash('/trigger');\n                console.log(\"已觸發: /trigger\");\n            } catch (error) {\n                console.error(\"觸發動作時出錯:\", error);\n            }\n        } else {\n            console.warn(\"SillyTavern API 'triggerSlash' 未找到。無法觸發: /trigger\");\n        }\n        closeDialog();\n    }\n\n    function handleFirstInteraction() {\n        if (!state.userInteracted) {\n            state.userInteracted = true;\n            if (DOM.bgmPlayer.src && DOM.bgmPlayer.paused && !state.isMuted) {\n                DOM.bgmPlayer.play().catch(e => {});\n            }\n        }\n    }\n\n    function getCurrentInfo() {\n        return state.messageInfo[state.currentMessageIndex] || {type: 'dialog', name: '系統消息', content: ''};\n    }\n\n    function showErrorToast(message) {\n        DOM.errorToast.textContent = message;\n        DOM.errorToast.classList.remove('hide');\n        DOM.errorToast.offsetHeight;\n        DOM.errorToast.classList.add('show');\n\n        setTimeout(() => {\n            DOM.errorToast.classList.remove('show');\n            DOM.errorToast.classList.add('hide');\n            DOM.errorToast.addEventListener('animationend', function handler(e) {\n                if (e.animationName === 'toastSlideOut') {\n                    DOM.errorToast.classList.remove('hide');\n                    DOM.errorToast.removeEventListener('animationend', handler);\n                }\n            });\n        }, 3000);\n    }\n\n    // --- Start ---\n    window.addEventListener('load', init);\n  </script>\n</body>\n```",
    "trimStrings": [],
    "placement": [
        2
    ],
    "disabled": false,
    "markdownOnly": true,
    "promptOnly": false,
    "runOnEdit": false,
    "substituteRegex": 0,
    "minDepth": 0,
    "maxDepth": 2
}
